(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[974],{3168:(e,s,r)=>{"use strict";r.d(s,{N:()=>l,k:()=>d});var a=r(851),t=r(9535);let n="https://xdhyqibdexidmldpfvhd.supabase.co",i="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhkaHlxaWJkZXhpZG1sZHBmdmhkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDI2MDkzNzEsImV4cCI6MjA1ODE4NTM3MX0.82OZoLiinChTO7VQ7t2b94dQTHvWYISOmPEQGcuGJqQ",l=(0,a.UU)(n,i),d=()=>(0,t.createBrowserClient)(n,i)},4551:(e,s,r)=>{Promise.resolve().then(r.bind(r,5914))},5914:(e,s,r)=>{"use strict";r.r(s),r.d(s,{default:()=>o});var a=r(5155),t=r(2115),n=r(3168);function i(e){let{onSelectSession:s,selectedSessionId:r}=e,[i,l]=(0,t.useState)([]),[d,o]=(0,t.useState)(!0);return(0,t.useEffect)(()=>{async function e(){try{o(!0);let{data:e,error:a}=await n.N.from("n8n_chat_histories").select("*");if(a)throw a;let t=new Map;e.forEach(e=>{let s=t.get(e.session_id);s?new Date(e.created_at)>new Date(s.updated_at||"")&&(s.last_message=e.message.content,s.updated_at=e.created_at):t.set(e.session_id,{session_id:e.session_id,messages:[],last_message:e.message.content,updated_at:e.created_at})});let i=Array.from(t.values()).sort((e,s)=>new Date(s.updated_at||"").getTime()-new Date(e.updated_at||"").getTime());l(i),!r&&i.length>0&&s(i[0].session_id)}catch(e){console.error("Error fetching sessions:",e)}finally{o(!1)}}e();let a=n.N.channel("n8n_chat_changes").on("postgres_changes",{event:"*",schema:"public",table:"n8n_chat_histories"},e).subscribe();return()=>{n.N.removeChannel(a)}},[s,r]),(0,a.jsxs)("div",{className:"w-full h-full bg-gray-100 dark:bg-gray-800 p-4 overflow-y-auto",children:[(0,a.jsx)("h2",{className:"text-lg font-bold mb-4",children:"Chat Sessions"}),d?(0,a.jsx)("div",{className:"flex justify-center items-center h-32",children:(0,a.jsx)("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900 dark:border-white"})}):0===i.length?(0,a.jsx)("p",{className:"text-gray-500 dark:text-gray-400 text-center",children:"No chat sessions found"}):(0,a.jsx)("div",{className:"space-y-2",children:i.map(e=>{let t="Unknown",n="\uD83D\uDCAC";return e.session_id.includes("line")?(t="LINE",n="\uD83D\uDFE2"):e.session_id.includes("messenger")?(t="Messenger",n="\uD83D\uDD35"):(e.session_id.includes("instagram")||e.session_id.includes("ig"))&&(t="Instagram",n="\uD83D\uDCF8"),(0,a.jsxs)("button",{onClick:()=>s(e.session_id),className:"w-full text-left p-3 rounded-lg transition-colors ".concat(r===e.session_id?"bg-blue-100 dark:bg-blue-900":"hover:bg-gray-200 dark:hover:bg-gray-700"),children:[(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)("span",{children:n}),(0,a.jsx)("span",{className:"truncate font-medium",children:e.session_id})]}),(0,a.jsx)("span",{className:"text-xs text-gray-500 dark:text-gray-400",children:e.updated_at&&new Date(e.updated_at).toLocaleDateString()})]}),e.last_message&&(0,a.jsx)("p",{className:"text-sm text-gray-500 dark:text-gray-400 truncate mt-2 pl-6",children:e.last_message.length>30?e.last_message.substring(0,30)+"...":e.last_message}),(0,a.jsx)("div",{className:"mt-1 text-xs text-gray-400 dark:text-gray-500 pl-6",children:t})]},e.session_id)})})]})}function l(e){var s;let{sessionId:r}=e,[i,l]=(0,t.useState)([]),[d,o]=(0,t.useState)(!1),c=(0,t.useRef)(null);if((0,t.useEffect)(()=>{async function e(){if(r)try{o(!0);let{data:e,error:s}=await n.N.from("n8n_chat_histories").select("*").eq("session_id",r);if(s)throw s;let a=e.map(e=>({id:e.id,type:e.message.type,content:e.message.content,created_at:e.created_at}));l(a)}catch(e){console.error("Error fetching messages:",e)}finally{o(!1)}}e();let s=n.N.channel("session_".concat(r)).on("postgres_changes",{event:"*",schema:"public",table:"n8n_chat_histories",filter:"session_id=eq.".concat(r)},e).subscribe();return()=>{n.N.removeChannel(s)}},[r]),(0,t.useEffect)(()=>{var e;null===(e=c.current)||void 0===e||e.scrollIntoView({behavior:"smooth"})},[i]),!r)return(0,a.jsx)("div",{className:"flex-1 flex justify-center items-center p-4 bg-white dark:bg-gray-900",children:(0,a.jsx)("p",{className:"text-gray-500 dark:text-gray-400",children:"Select a chat session to view messages"})});let m=r?(s=r).includes("line")?{name:"LINE",icon:"\uD83D\uDFE2",color:"bg-green-500"}:s.includes("messenger")?{name:"Messenger",icon:"\uD83D\uDD35",color:"bg-blue-600"}:s.includes("instagram")||s.includes("ig")?{name:"Instagram",icon:"\uD83D\uDCF8",color:"bg-purple-500"}:{name:"Unknown",icon:"\uD83D\uDCAC",color:"bg-gray-500"}:{name:"",icon:"",color:""};return(0,a.jsx)("div",{className:"flex-1 p-4 bg-white dark:bg-gray-900 overflow-y-auto",children:(0,a.jsxs)("div",{className:"max-w-4xl mx-auto",children:[r&&(0,a.jsxs)("div",{className:"flex items-center gap-2 mb-6 pb-3 border-b border-gray-200 dark:border-gray-700",children:[(0,a.jsx)("span",{className:"text-xl",children:m.icon}),(0,a.jsxs)("h2",{className:"text-xl font-bold",children:[m.name," Session"]}),(0,a.jsxs)("span",{className:"text-sm text-gray-500 dark:text-gray-400 ml-2",children:["ID: ",r]})]}),d&&0===i.length?(0,a.jsx)("div",{className:"flex justify-center items-center h-32",children:(0,a.jsx)("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900 dark:border-white"})}):0===i.length?(0,a.jsx)("p",{className:"text-center text-gray-500 dark:text-gray-400",children:"No messages in this session"}):(0,a.jsxs)("div",{className:"space-y-4",children:[i.map((e,s)=>{let r="human"===e.type,t=s>0&&new Date(e.created_at||"").toDateString()!==new Date(i[s-1].created_at||"").toDateString();return(0,a.jsxs)("div",{children:[t&&(0,a.jsx)("div",{className:"flex justify-center my-6",children:(0,a.jsx)("div",{className:"px-4 py-1 bg-gray-100 dark:bg-gray-800 rounded-full text-xs text-gray-500 dark:text-gray-400",children:new Date(e.created_at||"").toLocaleDateString()})}),(0,a.jsxs)("div",{className:"flex items-end gap-2 ".concat(r?"justify-end":"justify-start"),children:[!r&&(0,a.jsx)("div",{className:"w-8 h-8 rounded-full flex items-center justify-center ".concat(m.color," text-white flex-shrink-0"),children:m.icon}),(0,a.jsxs)("div",{className:"max-w-[80%] p-3 rounded-lg ".concat(r?"bg-blue-500 text-white rounded-br-none":"bg-gray-200 dark:bg-gray-700 rounded-bl-none"),children:[(0,a.jsx)("div",{className:"whitespace-pre-wrap",children:e.content}),e.created_at&&(0,a.jsx)("div",{className:"text-xs opacity-70 mt-1",children:new Date(e.created_at).toLocaleTimeString()})]}),r&&(0,a.jsx)("div",{className:"w-8 h-8 rounded-full bg-gray-300 dark:bg-gray-600 flex items-center justify-center text-gray-700 dark:text-gray-300 flex-shrink-0",children:"\uD83D\uDC64"})]})]},e.id)}),(0,a.jsx)("div",{ref:c})]})]})})}function d(e){let{sessionId:s,onNewSession:r}=e,[i,l]=(0,t.useState)(""),[d,o]=(0,t.useState)(""),[c,m]=(0,t.useState)(!1),[g,h]=(0,t.useState)(!1);async function x(e){if(e.preventDefault(),i.trim()){if(s){try{if(h(!0),"file:"===window.location.protocol){setTimeout(()=>{alert("This is a static demo version. In the hosted version, messages would be sent to the API."),l(""),h(!1)},1e3);return}let{error:e}=await n.N.from("n8n_chat_histories").insert({session_id:s,message:{type:"human",content:i.trim()}});if(e)throw e;l("");try{await fetch("/api/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({session_id:s,message:i.trim()})})}catch(e){console.error("Error getting AI response:",e)}}catch(e){console.error("Error sending message:",e),alert("Failed to send message")}finally{h(!1)}return}if(!b||!d.trim()){alert("Please select a platform and enter a session ID");return}try{h(!0);let e="".concat(b,"_").concat(d.trim());if("file:"===window.location.protocol){setTimeout(()=>{alert("This is a static demo version. In the hosted version, a new chat session would be created."),r(e),o(""),u(""),m(!1),l(""),h(!1)},1e3);return}let{error:s}=await n.N.from("n8n_chat_histories").insert({session_id:e,message:{type:"human",content:i.trim()}});if(s)throw s;r(e),o(""),u(""),m(!1),l("");try{await fetch("/api/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({session_id:e,message:i.trim()})})}catch(e){console.error("Error getting AI response:",e)}}catch(e){console.error("Error sending message:",e),alert("Failed to send message")}finally{h(!1)}}}let[b,u]=(0,t.useState)("");return c?(0,a.jsx)("div",{className:"p-4 border-t border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-900",children:(0,a.jsxs)("div",{className:"max-w-4xl mx-auto",children:[(0,a.jsx)("h3",{className:"text-lg font-medium mb-4",children:"Create New Chat Session"}),(0,a.jsxs)("form",{className:"flex flex-col space-y-4",onSubmit:x,children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium mb-2",children:"Platform"}),(0,a.jsxs)("div",{className:"flex flex-wrap gap-2",children:[(0,a.jsxs)("button",{type:"button",className:"flex items-center gap-2 px-4 py-2 rounded-md border ".concat("line"===b?"bg-green-100 dark:bg-green-900 border-green-500":"bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-700"),onClick:()=>u("line"),children:[(0,a.jsx)("span",{children:"\uD83D\uDFE2"}),(0,a.jsx)("span",{children:"LINE"})]}),(0,a.jsxs)("button",{type:"button",className:"flex items-center gap-2 px-4 py-2 rounded-md border ".concat("messenger"===b?"bg-blue-100 dark:bg-blue-900 border-blue-500":"bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-700"),onClick:()=>u("messenger"),children:[(0,a.jsx)("span",{children:"\uD83D\uDD35"}),(0,a.jsx)("span",{children:"Messenger"})]}),(0,a.jsxs)("button",{type:"button",className:"flex items-center gap-2 px-4 py-2 rounded-md border ".concat("instagram"===b?"bg-purple-100 dark:bg-purple-900 border-purple-500":"bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-700"),onClick:()=>u("instagram"),children:[(0,a.jsx)("span",{children:"\uD83D\uDCF8"}),(0,a.jsx)("span",{children:"Instagram"})]})]})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{htmlFor:"session-id",className:"block text-sm font-medium mb-1",children:"Session ID"}),(0,a.jsxs)("div",{className:"flex",children:[b&&(0,a.jsxs)("span",{className:"inline-flex items-center px-3 rounded-l-md border border-r-0 border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-500 dark:text-gray-400",children:[b,"_"]}),(0,a.jsx)("input",{id:"session-id",type:"text",value:d,onChange:e=>o(e.target.value),placeholder:"Enter a unique identifier (e.g. customer name or ID)",className:"w-full p-2 border border-gray-300 dark:border-gray-600 ".concat(b?"rounded-r-md":"rounded-md"," bg-white dark:bg-gray-800 focus:ring-2 focus:ring-blue-500 focus:border-transparent"),required:!0})]}),(0,a.jsxs)("p",{className:"text-xs text-gray-500 mt-1",children:["Complete session ID will be: ",b&&"".concat(b,"_"),d||"example"]})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{htmlFor:"message",className:"block text-sm font-medium mb-1",children:"First Message"}),(0,a.jsx)("textarea",{id:"message",value:i,onChange:e=>l(e.target.value),placeholder:"Type your message...",className:"w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 focus:ring-2 focus:ring-blue-500 focus:border-transparent min-h-[80px]",required:!0})]}),(0,a.jsxs)("div",{className:"flex space-x-2 pt-2",children:[(0,a.jsx)("button",{type:"button",onClick:function(){m(!1),o("")},className:"px-4 py-2 text-gray-700 dark:text-gray-200 bg-gray-200 dark:bg-gray-700 rounded-md hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors",disabled:g,children:"Cancel"}),(0,a.jsx)("button",{type:"submit",className:"px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center",disabled:g||!b||!d.trim()||!i.trim(),children:g?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("span",{className:"animate-spin mr-2",children:"↻"})," Creating..."]}):"Create & Send"})]})]})]})}):(0,a.jsx)("div",{className:"p-4 border-t border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-900",children:(0,a.jsx)("div",{className:"max-w-4xl mx-auto",children:s?(0,a.jsxs)("form",{className:"flex flex-col space-y-2",onSubmit:x,children:[(0,a.jsxs)("div",{className:"flex space-x-2",children:[(0,a.jsx)("textarea",{value:i,onChange:e=>l(e.target.value),placeholder:"Type your message...",className:"flex-1 p-3 border border-gray-300 dark:border-gray-600 rounded-l-md bg-white dark:bg-gray-800 focus:ring-2 focus:ring-blue-500 focus:border-transparent min-h-[50px] max-h-[120px] resize-y",onKeyDown:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),x(e))}}),(0,a.jsx)("button",{type:"submit",className:"px-4 py-2 bg-blue-500 text-white rounded-r-md hover:bg-blue-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed self-stretch flex items-center justify-center",disabled:g||!i.trim(),children:g?(0,a.jsx)("span",{className:"animate-spin",children:"↻"}):(0,a.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor",children:(0,a.jsx)("path",{fillRule:"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 1.414L10.586 9H7a1 1 0 100 2h3.586l-1.293 1.293a1 1 0 101.414 1.414l3-3a1 1 0 000-1.414z",clipRule:"evenodd"})})})]}),(0,a.jsxs)("div",{className:"text-xs text-gray-500 dark:text-gray-400 flex justify-between",children:[(0,a.jsx)("span",{children:"Press Shift+Enter for new line"}),(0,a.jsxs)("span",{children:[i.length," characters"]})]})]}):(0,a.jsxs)("div",{className:"flex flex-col items-center justify-center py-6 space-y-4",children:[(0,a.jsxs)("div",{className:"text-center mb-2",children:[(0,a.jsx)("h3",{className:"text-lg font-medium mb-1",children:"Welcome to the Message Management System"}),(0,a.jsx)("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:"Select a chat session from the sidebar or create a new one"})]}),(0,a.jsxs)("button",{onClick:function(){m(!0)},className:"px-6 py-3 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition-colors flex items-center gap-2",children:[(0,a.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor",children:(0,a.jsx)("path",{fillRule:"evenodd",d:"M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z",clipRule:"evenodd"})}),"Create New Chat Session"]})]})})})}function o(){let[e,s]=(0,t.useState)(null);return(0,a.jsxs)("div",{className:"flex flex-col h-screen",children:[(0,a.jsx)("header",{className:"p-4 bg-white dark:bg-gray-900 border-b border-gray-200 dark:border-gray-700",children:(0,a.jsx)("h1",{className:"text-2xl font-bold text-center",children:"訊息管理系統"})}),(0,a.jsxs)("div",{className:"flex flex-1 overflow-hidden",children:[(0,a.jsx)("div",{className:"w-80 border-r border-gray-200 dark:border-gray-700 hidden md:block",children:(0,a.jsx)(i,{onSelectSession:s,selectedSessionId:e})}),(0,a.jsxs)("div",{className:"md:hidden p-2 bg-gray-100 dark:bg-gray-800",children:[(0,a.jsx)("button",{className:"w-full py-2 px-4 bg-blue-500 text-white rounded-md",onClick:()=>{let e=document.getElementById("mobile-sidebar");e&&e.classList.toggle("hidden")},children:e?"Session: ".concat(e):"Select Session"}),(0,a.jsxs)("div",{id:"mobile-sidebar",className:"hidden fixed inset-0 z-50 bg-white dark:bg-gray-900",children:[(0,a.jsxs)("div",{className:"flex justify-between items-center p-4 border-b border-gray-200 dark:border-gray-700",children:[(0,a.jsx)("h2",{className:"text-lg font-bold",children:"Chat Sessions"}),(0,a.jsx)("button",{onClick:()=>{let e=document.getElementById("mobile-sidebar");e&&e.classList.add("hidden")},className:"p-2",children:"✕"})]}),(0,a.jsx)("div",{className:"h-full",children:(0,a.jsx)(i,{onSelectSession:e=>{s(e);let r=document.getElementById("mobile-sidebar");r&&r.classList.add("hidden")},selectedSessionId:e})})]})]}),(0,a.jsxs)("div",{className:"flex-1 flex flex-col",children:[(0,a.jsx)(l,{sessionId:e}),(0,a.jsx)(d,{sessionId:e,onNewSession:s})]})]})]})}}},e=>{var s=s=>e(e.s=s);e.O(0,[535,441,684,358],()=>s(4551)),_N_E=e.O()}]);